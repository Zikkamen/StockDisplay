<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Display</title>
    <link href="http://45.83.104.11:7878/files/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://45.83.104.11:7878/files/static/js/chart.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/luxon.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/chartjs-chart-financial.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/chartjs-adapter-luxon.js"></script>
  </head>
  <body>
    <div style="min-width: 1220px">
      <div style="min-width: 1200px; margin-left: 10px; margin-right: 10px; margin-top: 10px;">
        <h3><a href="/" style="text-decoration: none; color: black;">Realtime chart {{ stock_name }}</a></h3>
        <div class="btn-group btn-group-toggle" data-toggle="buttons" style="float: right; margin-bottom: 20px;">
          <label class="btn btn-secondary active">
            <input type="radio" name="options" id="one_sec" autocomplete="off" onClick="time_interval_change(this.id)"> 1 Second
          </label>
          <label class="btn btn-secondary">
            <input type="radio" name="options" id="ten_sec" autocomplete="off" onClick="time_interval_change(this.id)"> 10 Seconds
          </label>
          <label class="btn btn-secondary">
            <input type="radio" name="options" id="one_min" autocomplete="off" onClick="time_interval_change(this.id)"> 1 Minute
          </label>
          <label class="btn btn-secondary">
            <input type="radio" name="options" id="five_min" autocomplete="off" onClick="time_interval_change(this.id)"> 5 Minutes
          </label>
          <label class="btn btn-secondary">
            <input type="radio" name="options" id="ten_min" autocomplete="off" onClick="time_interval_change(this.id)"> 10 Minutes
          </label>
        </div>
        <canvas id="chart"></canvas>
      </div>
    </div>
  </body>
</html>
<script>
  var barCount = 60;
  var initialDateStr = new Date().toUTCString();

  var ctx = document.getElementById('chart').getContext('2d');
  ctx.canvas.width = 800;
  ctx.canvas.height = 250;

  var barData = [];
  var lineData = [];

  var chart = new candlestick_graph();
  let update_data = false;

  const socket = new WebSocket("ws://localhost:9002");

  socket.addEventListener("open", (event) => {
    socket.send('{"stock": "{{ stock_name }}", "interval":1}');
  });

  // Listen for messages
  socket.addEventListener("message", (event) => {
    if(event.data == "End of update") {
      update_data = true;
      chart.update();
      
      return;
    }

    let parsed_data = JSON.parse(event.data);

    if(parsed_data.avg_price - parsed_data.min_price > 1) {
      parsed_data.min_price = parsed_data.avg_price;
    }

    if(parsed_data.max_price - parsed_data.avg_price > 1) {
      parsed_data.max_price = parsed_data.avg_price;
    }

    console.log(parsed_data);

    if(lineData[0].x == 0) {
      barData.shift();
      lineData.shift();
    }

    barData.push(
        {
        x: parsed_data.timestamp,
        o: parsed_data.avg_price_open,
        h: parsed_data.max_price,
        l: parsed_data.min_price,
        c: parsed_data.avg_price
      }
    );

    lineData.push({x: parsed_data.timestamp, y: parsed_data.volume_moved});

    if(barData.length >= 120) {
      barData.shift();
      lineData.shift();
    }

    if(update_data) {
      chart.update();
    }
  });

  let current_active = "one_sec";

  function time_interval_change(button_id){
    document.getElementById(current_active).parentNode.className = "btn btn-secondary";
    document.getElementById(button_id).parentNode.className = "btn btn-secondary active";
    current_active = button_id;

    while(barData.length > 0) {
      barData.pop();
    }

    while(lineData.length > 0) {
      lineData.pop();
    }

    chart.destroy();
    chart = new candlestick_graph();
    update_data = false;

    switch(current_active) {
      case "one_sec":
        socket.send('{"stock": "{{ stock_name }}", "interval":1}');
        break;
      case "ten_sec":
        socket.send('{"stock": "{{ stock_name }}", "interval":10}');
        break;
      case "one_min":
        socket.send('{"stock": "{{ stock_name }}", "interval":60}');
        break;
      case "five_min":
        socket.send('{"stock": "{{ stock_name }}", "interval":300}');
        break;
      case "ten_min":
        socket.send('{"stock": "{{ stock_name }}", "interval":600}');
        break;
      default:
        break
    }
  }

  function candlestick_graph() {
    init_data();

    return new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: 'Price',
          data: barData,
          yAxisID: 'left-y-axis'
        }, {
          label: 'Volume',
          type: 'scatter',
          data: lineData,
          borderColor: 'blue',
          yAxisID: 'right-y-axis'
        }]
      },
      options: {
          scales: {
              'left-y-axis': {
                  type: 'linear',
                  position: 'left'
              },
              'right-y-axis': {
                  type: 'linear',
                  position: 'right'
              }
          }
      }
    });
  }

  function init_data() {
    lineData = [];
    barData = [];

    barData.push({
      x: 0,
      o: 0,
      h: 0,
      l: 0,
      c: 0
      });

    lineData.push({x: 0, y: 0});
  }
</script>