<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Display</title>
    <link href="http://45.83.104.11:7878/files/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://45.83.104.11:7878/files/static/js/chart.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/luxon.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/chartjs-chart-financial.js"></script>
    <script src="http://45.83.104.11:7878/files/static/js/chartjs-adapter-luxon.js"></script>
  </head>
  <body>
    <h1>StockDisplay</h1>

    <h1 style="max-width: fit-content; margin-left: auto; margin-right: auto;">{{ stock_name }}</h1>
    <div style="min-width: 1200px; margin-left: 100px; margin-right: 100px; margin-top: 100px;">
      <h2>Realtime chart</h2>
      <canvas id="chart"></canvas>
    </div>
  </body>
</html>
<script>
  var barCount = 60;
  var initialDateStr = new Date().toUTCString();

  var ctx = document.getElementById('chart').getContext('2d');
  ctx.canvas.width = 800;
  ctx.canvas.height = 200;

  var barData = [];
  var lineData = [];

  barData.push(
      {
      x: 0,
      o: 0,
      h: 0,
      l: 0,
      c: 0
    }
  );

  lineData.push({x: 0, y: 0});

  var chart = new Chart(ctx, {
    type: 'candlestick',
    data: {
      datasets: [{
        label: 'Candlestick Graph',
        data: barData,
        yAxisID: 'left-y-axis'
      }, {
        label: 'Close price',
        type: 'scatter',
        data: lineData,
        borderColor: 'blue',
        yAxisID: 'right-y-axis'
      }]
    },
    options: {
        scales: {
            'left-y-axis': {
                type: 'linear',
                position: 'left'
            },
            'right-y-axis': {
                type: 'linear',
                position: 'right'
            }
        }
    }
  });

  const socket = new WebSocket("ws://localhost:9002");

  socket.addEventListener("open", (event) => {
    socket.send('{"stock": "{{ stock_name }}"}');
  });

  // Listen for messages
  socket.addEventListener("message", (event) => {
    let parsed_data = JSON.parse(event.data);

    if(parsed_data.stock_interval != 1) {
      return;
    }

    barData.push(
        {
        x: parsed_data.timestamp,
        o: parsed_data.avg_price_open,
        h: parsed_data.max_price,
        l: parsed_data.min_price,
        c: parsed_data.avg_price
      }
    );

    lineData.push({x: parsed_data.timestamp, y: parsed_data.volume_moved});

    if(barData.length >= 61) {
      barData.shift();
      lineData.shift();
      chart.update();
    }
  });
</script>